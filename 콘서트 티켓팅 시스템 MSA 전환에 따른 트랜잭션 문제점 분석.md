# 콘서트 티켓팅 시스템 MSA 전환에 따른 트랜잭션 문제점 분석
###### 콘서트 티켓팅 시스템을 마이크로서비스 아키텍처(MSA)로 전환하고, 그에 따른 트랜잭션 처리의 한계와 해결방안에 대해 논해보자

   <br>

## 1. 기존 시스템 : 하나의 애플리케이션
콘서트 조회 > 대기열 > 날짜 및 좌석 조회 > 예약 > 포인트 충전/사용 > 결제   

   <br>

## 2. MSA 서비스 분리 방안
> MSA(Microservices Architecture) 서비스란?   
> 소프트웨어 시스템을 여러 개의 독립적인 서비스로 분할하여 개발하고 배포하는 구조로, 각 서비스는 독립적으로 운영되며, 특정 비즈니스 기능을 담당한다. 이러한 아키텍처는 시스템의 유연성을 높이고, 각 서비스의 독립적인 개발, 배포, 스케일링을 가능하게 한다.
  <br>
   
### 2-1. 콘서트 서비스
#### 1) 기능 : 콘서트 정보 조회 및 관리
#### 2) 주요 작업
- 콘서트 리스트 조회
- 콘서트 상세 정보 제공
- 콘서트 일정 관리

   <br>

### 2-2. 대기열 서비스
#### 1) 기능 : 대기열 관리
#### 2) 주요 작업
- 토큰 생성 및 관리
- 대기열 순위 조회
- 토큰 상태 업데이트
- 대기열 관리 스케쥴러
- 토큰 만료 처리

   <br>

### 2-3. 좌석 관리 서비스
#### 1) 기능 : 좌석 관련 정보 처리
#### 2) 주요 작업
- 좌석 배치도 제공
- 예약 가능한 좌석 정보 제공

  <br>

### 2-4. 예약 서비스
#### 1) 기능 : 예약 처리 및 관리
#### 2) 주요 작업
- 예약 생성
- 예약 상태 업데이트
- 예약 상태 관리 스케쥴러

  <br>

### 2-5. 포인트 서비스
#### 1) 기능 : 포인트 충전 및 사용 관리
#### 2) 주요 작업
- 포인트 충전
- 포인트 사용
- 포인트 내역 조회

  <br>

### 2-5. 결제 서비스
#### 1) 기능 : 결제 처리 및 관리
#### 2) 주요 작업
- 결제 요청 처리
  
  <br>

### 2-5. 유저 서비스
#### 1) 기능 : 사용자 정보 관리
#### 2) 주요 작업
- 사용자 등록 및 관리
- 사용자 정보 조회
- 사용자 정보 업데이트
- 사용자 탈퇴
   
  <br>

### 2-6. 타 플랫폼에 정보 제공 서비스
#### 1) 기능 : 예약된 좌석 정보 등을 타 플랫폼에 제공
- 정보 제공
  
  <br>

## 3. 서비스 간의 상호작용
- 콘서트 서비스는 좌석 관리 서비스와 연동되어 콘서트 정보와 좌석 정보를 제공하며, 예약 서비스와 협력하여 좌석 예약 상태를 관리한다.
- 대기열 서비스는 좌석 관리 서비스 및 예약 서비스와 상호작용하여 대기열의 상태를 유지한다.
- 포인트 서비스는 유저 서비스, 결제 서비스와 연동하여 포인트 충전 및 사용을 처리한다.
- 결제 서비스는 예약 서비스와 협력하여 결제를 처리하며, 결제 후 예약 상태를 업데이트한다.
- 유저 서비스는 인증 서비스와 연동하여 사용자 인증 및 권한 관리를 지원한다.
- 정보 제공 서비스는 결제가 완료되면 다른 서비스로부터 정보를 받아(ex.예약된 좌석 정보) 타 플랫폼에 제공한다.
  
  <br>

## 4. 서비스 분리 시 트랜잭션 처리에서 발생할 수 있는 문제점 및 해결 방안
######  서비스를 마이크로서비스 아키텍처(MSA)로 분리할 때, 여러 개의 서비스가 하나의 트랜잭션으로 동작하던 서비스는 문제가 발생할 수 도 있다. 여기서는 결제 서비스를 예로 들어 트랜잭션 관리 시 발생할 수 있는 문제점과 해결 방안을 설명한다.
   
### 4-1. 트랜잭션의 일관성 문제
#### 1) 문제   
```

결제() {
  사용자 조회(유저 서비스)
  예약 조회(예약 서비스)
  포인트 사용(포인트 서비스)
  예약 완료 처리(예약 서비스)
}

```

   서비스가 분리되어 있을 경우, 여러 서비스에 걸쳐 있는 작업을 수행하면서 트랜잭션의 일관성을 유지하는 것이 어렵다. 결제 서비스는 유저 서비스, 예약 서비스, 포인트 서비스와 연동되며, 각 서비스에서 데이터를 처리하는 동안 어느 하나에서 실패가 발생하면 전체 트랜잭션의 일관성이 깨질 수 있다. 만약 포인트 사용 후 예약 완료 처리 단계에서 실패가 발생하면, 포인트는 이미 사용되었지만 예약 상태가 완료되지 않은 상태로 남아 일관성이 깨질 수 있다.

#### 2) 해결 방안:
- SAGA 패턴: 결제 서비스에서 각 단계의 작업이 성공하지 않을 경우, 앞선 단계에서 수행된 작업을 취소하는 보상 트랜잭션을 실행한다. 예를 들어, 예약 완료 처리에 실패하면 포인트 사용을 취소하는 로직을 추가하여 전체 트랜잭션의 일관성을 유지한다.
- 2단계 커밋(2PC): 트랜잭션의 원자성을 보장하기 위해, 각 서비스가 트랜잭션 준비 상태를 확인한 후 최종적으로 커밋하거나 롤백하는 방식으로 처리한다. 다만, 2PC는 성능 저하를 초래할 수 있으므로 상황에 따라 적절히 사용해야 한다.
  
  <br>

### 4-2. 트랜잭션의 복잡성 문제
#### 1) 문제
각 서비스가 서로 다른 비즈니스 로직을 처리하면서 결제 서비스의 트랜잭션이 복잡해진다. 여러 서비스가 참여하는 트랜잭션의 상태를 추적하고 관리하는 데 어려움이 있을 수 있다.
#### 2) 해결 방안
- 분산 트랜잭션 관리 도구: 트랜잭션 관리 도구를 활용하여 각 서비스의 트랜잭션 상태를 중앙에서 모니터링하고 조정한다. 이를 통해 복잡한 트랜잭션의 상태를 쉽게 관리할 수 있다.
- 트랜잭션 로그 및 모니터링: 모든 트랜잭션 상태를 로깅하고 모니터링하여 문제 발생 시 신속하게 원인을 파악하고 대응할 수 있도록 한다.
  
  <br>

### 4-3. 트랜잭션의 성능 문제
#### 1) 문제
트랜잭션은 여러 서비스에 걸쳐 이루어지므로, 네트워크 지연이나 서비스 호출로 인해 성능 저하가 발생할 수 있다. 결제 서비스에서 각 단계가 다른 서비스와의 통신을 통해 처리되므로, 이 과정에서 성능 문제가 발생할 수 있다.

#### 2) 해결 방안
- 트랜잭션 최적화: 각 서비스 호출을 최적화하여 성능을 향상시킨다. 예를 들어, 불필요한 호출을 줄이고 데이터를 캐싱하는 방법으로 응답 시간을 줄인다.
- 비동기 처리 및 큐 시스템: 성능 저하를 방지하기 위해 비동기적으로 트랜잭션을 처리하거나, 큐 시스템을 통해 요청을 분산 처리하여 시스템의 성능을 최적화한다.
